
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Room Rules OCR + Подсветка</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
  <style>
    canvas { border: 1px solid #ccc; display: block; margin-top: 10px; }
    #output { white-space: pre-wrap; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Room Rules OCR + Подсветка</h2>
  <input type="file" id="fileInput" />
  <canvas id="canvas"></canvas>
  <pre id="output">Здесь будет текст...</pre>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const output = document.getElementById('output');

    fileInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      output.textContent = 'Распознавание...';

      let img = new Image();
      let imageData;

      if (file.type === 'application/pdf') {
        const pdfURL = URL.createObjectURL(file);
        const pdf = await pdfjsLib.getDocument({ url: pdfURL }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2.0 });
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        imageData = canvas.toDataURL();
      } else {
        const reader = new FileReader();
        imageData = await new Promise(resolve => {
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        await new Promise(resolve => {
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            resolve();
          };
          img.src = imageData;
        });
      }

      const worker = await Tesseract.createWorker({ logger: m => console.log(m) });
      await worker.loadLanguage('eng+rus');
      await worker.initialize('eng+rus');
      const { data } = await worker.recognize(imageData);
      await worker.terminate();

      output.textContent = data.text;

      ctx.font = "16px Arial";
      ctx.strokeStyle = "red";
      ctx.fillStyle = "red";
      ctx.lineWidth = 2;

      data.words.forEach(word => {
        const text = word.text.toLowerCase();
        if (text.includes("коридор") || text.includes("corridor")) {
          const nextWord = data.words.find(w =>
            w.bbox.x0 > word.bbox.x1 &&
            Math.abs(w.bbox.y0 - word.bbox.y0) < 30
          );

          if (nextWord && /[0-9.]+/.test(nextWord.text)) {
            const value = parseFloat(nextWord.text.replace(',', '.'));
            if (value > 0 && value < 1.2) {
              const { x0, y0, x1, y1 } = word.bbox;
              ctx.strokeRect(x0, y0, x1 - x0, y1 - y0);
              ctx.fillText("❌ < 1.2м", x0, y0 - 5);
            }
          }
        }
      });
    });
  </script>
</body>
</html>
